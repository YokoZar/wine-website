<?PHP

/* Banner Ad Code */
/* For WineHQ */

// path for banner ad
$bannerads_path = '../images/bannerads/';

// base filename of the static ad
$fixed_ad = 'cw-ad02';

// max count until we fix on static ad
$max_ads = 50;

// open file and display contents of selected tag (very simple)
function get_xml_tags ($file, $tags = null)
{
    if (is_array($tags) and file_exists($file))
    {
        $content = array();
        $fp = @fopen($file, "r");
	    $data = fread($fp, filesize($file));
	    @fclose($fp);
        foreach ($tags as $tag)
        {
            if (eregi("<" . $tag . ">(.*)</" . $tag . ">", $data, $out))
            {
                array_push($content, $out[1]);
            }
        }
        return $content;
    }
    else
    {
        return null;
    }
}
// end get_xml_tags()

// check cookie for ad counter
$whqac = 1;
if (isset($_COOKIE['whqac']))
    $whqac = $_COOKIE['whqac'];
unset($_COOKIE["whqac"]);
$whqac++;

// randomly select a banner and display it
if ($whqac >= $max_ads)
{
    // display fixed ad
    $whqac = $max_ads;
    $img = $fixed_ad;
}
else
{
    // display random ad
    $ads = array();
    $d = opendir($bannerads_path);
    while($entry = readdir($d))
    {
        if(!ereg("(.+)\\.gif$", $entry, $arr))
            continue;
        array_push($ads, $arr[1]);
    }
    closedir($d);
    sort($ads);
    $img = $ads[(rand(1,count($ads))-1)];
}
list($url, $alt) = get_xml_tags($bannerads_path.$img.'.xml', array('url', 'alt'));

// da banner
setcookie("whqac", $whqac, time()+60*60*24*1);
header("Expires: Mon, 26 Jul 1997 05:00:00 GMT");
header("Last-Modified: " . gmdate("D, d M Y H:i:s") . " GMT"); 
header("Cache-Control: no-store, no-cache, must-revalidate");
header("Cache-Control: post-check=0, pre-check=0", false);
header("Pragma: no-cache"); 
?>
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title><?=$alt?></title>
</head>
<body bgcolor="#000000" text="#FFFFFF" marginwidth="0" marginheight="0" style="margin:0px;"><a href="<?=$url?>"
target="_top"><img src="../images/bannerads/<?=$img?>.gif"
width="468" height="60" border="0" alt="<?=$alt?>" /></a> <?=$whqac?></body>
</html>
